#making the docker runner to run by default
default:
  tags:
    - docker

stages:
  - lint #code quality check
  - build #produce artifacts
  - test # testing
  - analyze # static analyze with SonarQube
  - report # Summary and Deployment

#frontend linting ( runs code checks that ensure style, syntax and structure consistency )
# if this stage fails, the whole pipeline stops, so saves resources

# ---------- LINT ----------
frontend-lint:
  stage: lint
  image: node:20 #tells the container which image to use for this job
  variables:
    NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/frontend/.npm"
  cache: #stores all the downloaded dependencies, so in future build it can be reused
    key: ${CI_COMMIT_REF_SLUG} #we keep different caches for each branch. The cache is stored on the runners host, which is outside the job's docker container
    paths:
      - frontend/.npm/
      - frontend/node_modules/
  before_script:
    - cd frontend
    - npm ci --prefer-offline --cache .npm --no-audit --legacy-peer-deps #installs all the dependencies from package.json ( wipes all the existing node modules and starts fresh)
  script:
    - npx eslint . --format json --output-file eslint-report.json #runs the linting
  artifacts:
    paths:
      - frontend/eslint-report.json
    when: always
    expire_in: 1 week
#  rules:
#    - changes:
#        - frontend/**/*
#    - when: never
  allow_failure: false

backend-lint:
  stage: lint
  image: gradle:8.4.0-jdk17
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle" #where we store the cache
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
      - backend/.gradle/
  before_script:
    - cd backend
  script:
    - ./gradlew clean test --no-daemon --console=plain
  artifacts:
    when: always
    reports:
      junit: backend/build/test-results/test/*.xml
    paths:
      - backend/build/reports/
    expire_in: 1 week
#  rules:
#    - changes:
#        - backend/**/*
#    - when: never
  allow_failure: false

# ---------- BUILD ----------
frontend-build:
  stage: build
  image: node:20
  dependencies:
    - frontend-lint
  variables:
    NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/frontend/.npm"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - frontend/.npm/
      - frontend/node_modules/
  before_script:
    - cd frontend
    - npm ci --prefer-offline --cache .npm --no-audit --legacy-peer-deps
  script:
    - npm run build -- --configuration=production
  artifacts:
    name: "frontend-dist-$CI_COMMIT_SHORT_SHA"
    paths:
      - frontend/dist/
    expire_in: 1 week
#  rules:
#    - changes:
#        - frontend/**/*
#    - when: never
  allow_failure: false

backend-build:
  stage: build
  image: gradle:8.4.0-jdk17
  dependencies:
    - backend-lint
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
      - backend/.gradle/
  before_script:
    - cd backend
  script:
    - ./gradlew clean assemble --no-daemon --build-cache
  artifacts:
    name: "backend-jar-$CI_COMMIT_SHORT_SHA"
    paths:
      - backend/build/libs/
      - backend/build/classes/
    expire_in: 1 week
#  rules:
#    - changes:
#        - backend/**/*
#    - when: never
  allow_failure: false

# ---------- TEST ----------
frontend-test:
  stage: test
  image: node:20
  dependencies:
    - frontend-build
  variables:
    NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/frontend/.npm"
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - frontend/.npm/
      - frontend/node_modules/
  before_script:
    - cd frontend
    - npm ci --prefer-offline --cache .npm --no-audit --legacy-peer-deps
  script:
    - npm run test
  artifacts:
    when: always
    paths:
      - frontend/coverage/
    reports:
      junit: frontend/test-results.xml
    expire_in: 1 week
#  rules:
#    - changes:
#        - frontend/**/*
#    - when: never
  allow_failure: false

backend-test:
  stage: test
  image: gradle:8.4.0-jdk17
  dependencies:
    - backend-build
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
      - backend/.gradle/
  before_script:
    - cd backend
  script:
    - ./gradlew test --no-daemon --build-cache
  artifacts:
    when: always
    paths:
      - backend/build/test-results/
      - backend/build/reports/tests/
    reports:
      junit: backend/build/test-results/test/*.xml
    expire_in: 1 week
#  rules:
#    - changes:
#        - backend/**/*
#    - when: never
  allow_failure: false

# ---------- ANALYZE ----------
backend-sonarqube:
  stage: analyze
  image: gradle:8.5-jdk17
  dependencies:
    - backend-test
    - backend-build
  variables:
    GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
    SONAR_USER_HOME: "$CI_PROJECT_DIR/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: gradle-sonar-cache
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
      - backend/.gradle/
      - .sonar/cache
  before_script:
    - cd backend
  script:
    - ./gradlew sonar -Dsonar.projectKey=careerpath-backend -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN_BACKEND -Dsonar.java.binaries=build/classes -Dsonar.junit.reportPaths=build/test-results/test
  artifacts:
    when: always
    paths:
      - backend/build/reports/
    expire_in: 1 week
  allow_failure: false
  only:
    - ci/refactor

frontend-sonarqube:
  stage: analyze
  image: sonarsource/sonar-scanner-cli:latest
  dependencies:
    - frontend-test
  variables:
    SONAR_USER_HOME: "$CI_PROJECT_DIR/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: sonar-frontend-cache
    paths:
      - .sonar/cache
  before_script:
    - cd frontend
  script:
    - sonar-scanner -Dsonar.typescript.tsconfigPath=tsconfig.sonar.json -Dsonar.projectKey=careerpath-frontend -Dsonar.sources=src -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN_FRONTEND -Dsonar.exclusions=**/node_modules/**,**/*.spec.ts -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info -Dsonar.junit.reportPaths=test-results.xml
  artifacts:
    when: always
    paths:
      - frontend/coverage/
      - frontend/test-results.xml
    expire_in: 1 week
  allow_failure: false
  only:
      - ci/refactor